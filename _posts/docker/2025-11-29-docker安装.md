---
title: docker安装
date: 2025-11-29 20:03:26 +0800
categories: [docker, 安装]
tags: [笔记]
media_subpath: /assets/img/docker/
---

## Centos安装Docker引擎

Docker 目前支持 CentOS 7 及以后的版本，内核版本必须是3.10。

- 查看操作系统版本: `cat /etc/redhat-release`
- 查看内核版本: `uname -r`

### 1、卸载旧版本

旧版本的 Docker 被叫做 docker 或 docker-engine，如果安装了旧版本的 Docker ，需要卸载掉它。

```shell
sudo yum remove docker \
docker-client \
docker-client-latest \
docker-common \
docker-latest \
docker-latest-logrotate \
docker-logrotate \
docker-engine
```

### 2、安装Docker

#### 方法1: 手动安装

1. 安装依赖的软件包
```shell
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
```

2. 添加Docker文档版本的yum源
```shell
<!-- 官方的yum源安装docker比较慢，我们配置国内比较快的yum源(阿里云)。 -->
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

3. 安装最新版本的docker引擎(社区版)
```shell
sudo yum -y install docker-ce docker-ce-cli containerd.io
```

#### 方法2: 使用脚本自动安装

```shell
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
```

  注意:
  1. 自动安装脚本会自动检测系统信息并进行相应配置。
  2. 安装方法1和安装方法2二者选其一即可。

#### 启动Docker服务

```shell
sudo systemctl start docker
```

![](hello-world-start.png)

#### 验证Docker是否可用

```shell
sudo docker run hello-world
```

![](hello-world-run.png)


#### 把普通用户添加到docker 组

每次使用docker的时候都需要使用root用户，比较麻烦。可用把普通用户添加到docker组，避免每次都添加sudo。

```shell
sudo usermod -aG docker atguigu
```
退出当前shell，重新进入shell。使刚才的配置生效。

## 镜像基本操作

镜像是 Docker 三大核心概念中最重要的，自 Docker 诞生之日起镜像就是相关社区最为热门的关键词。 Docker 运行容器前需要本地存在对应的镜像，如果镜像不存在Docker 会尝试先从默认镜像仓库下载，用户也可以通过配置，使用自定义的镜像仓库。

### 1、列出本机镜像

```shell
docker images
```
![](hello-world-images.png)

**说明:**

- REPOSITORY: 来源仓库。
- TAG: 镜像的标签信息，表示镜像的版本. 只是标记，并不能表示镜像内容。
- IMAGE ID: 镜像id，唯一表示一个镜像. 如果两个镜像的 ID 相同，说明它们实际上指向了同一 个镜像，只是具有不同标签名称而已。
- CREATED: 镜像的最后更新时间。
- SIZE:镜像大小。

### 2、获取一个新镜像

当我们在本地主机上使用一个不存在的镜像时 Docker 就会自动下载这个镜像。如果我们想预先下载这个镜像，我们可以使用 docker pull 命令来下载它。

```shell
docker pull hello-world
```

![](hello-world-pull.png)

下载完成后，可以使用这个镜像来运行容器。

### 3、配置国内镜像源地址

下载镜像的时候，默认是从官方地址下载，服务器在国外，速度比较慢，可以换成国内镜像。

**国内常用加速地址:**
- 网易：http://hub-mirror.c.163.com
- 中国科技大学：https://docker.mirrors.ustc.edu.cn
- 阿里云容器服务：https://cr.console.aliyun.com，首页点击“创建我的容器镜像” 得到一个专属的镜像加速地址，类似于https://abcdef.mirror.aliyuncs.com

配置方法：
```shell
sudo vim /etc/docker/daemon.json

{
"registry-mirrors": [
  "http://hub-mirror.c.163.com",
  "https://docker.mirrors.ustc.edu.cn",
  "https://813o9nus.mirror.aliyuncs.com"
]
}
```

说明:
1. 关于阿里云地址，参考: <https://help.aliyun.com/document_detail/60750.html?spm=a2c4g.11186623.6.550.469742c75wmmC8>
2. 重启：`docker: sudo systemctl restart docker`
3. 查看是否配置成功: `docker info`

![info](hello-world-info.png)

### 4、搜索镜像

```shell
docker search hello-world
```

![](hello-world-search.png)

### 5、删除镜像

- 使用tag删除镜像

```shell
docker rmi hello-world:latest
```

![](hello-world-rmi.png)

注意:
1. 如果删除的时候报错: 有容器使用了该镜像，则需要先删除使用过该镜像的容器，才能删除该镜像。
   ![](hello-world-rmi-e.png)
2. 删除容器，再删镜像。
   ![](hello-world-rm.png)

- 使用id删除镜像

```shell
docker rmi bf756fb1ae65
```
![](hello-world-rmi-id.png)

- 清理镜像

使用 Docker 一段时间后，系统中可能会遗留一些临时的镜像文件，以及一些没有被使用的镜像，可以通过 `docker image prune -f` 命令来进行清理。

## 容器基本操作

容器是 Docker 的另一个核心概念。 简单来说，容器是镜像的一个运行实例。所不同的是，镜像是静态的只读文件，而容器带有运行时需要的可写文件层，同时，容器中的应用进程处于运行状态。

如果认为虚拟机是模拟运行的一整套操作系统（包括内核、 应用运行态环境和其他系统环境）和跑在上面的应用。 那么 Docker 容器就是独立运行的一个（或一组）应用，以及它们必需的运行环境。

### 1、创建容器

1. 获取centos:7.5.1804的镜像
```shell
docker pull centos:7.5.1804
```
  ![](centos-pull.png)
2. 创建容器
```shell
docker create -i -t centos:7.5.1804 /bin/bash
```
  ![](centos-create.png)
  说明:
    1. 创建一个交互式的容器。
    2. -i: 允许你对容器内的标准输入 (STDIN) 进行交互。
    3. -t: 在新容器内指定一个伪终端或终端。
    
3. 启动容器
```shell
docker start bcc
```
  ![](centos-start.png)

4. 新建并启动容器
```shell
docker run -it centos:7.5.1804 /bin/bash
```
  前面的操作是先创建容器，然后再启动容器. 也可以使用run来直接新建并启动容器，启动一个交互式的centos容器。

5. 查看有哪些容器
   1.	查看启动的容器：`docker ps`
   ![](centos-ps.png)
   2.	查看所有容器：`docker ps -a`
   ![](centos-ps-a.png)

6. 启动后台容器进程
```shell
docker run -itd centos:7.5.1804 /bin/bash
```

### 2、停止容器

```shell
docker stop bcc
```
![](centos-stop.png)

### 3、进入容器

在使用 -d 参数时，容器启动后会进入后台(有些容器默认就是后台，比如centos容器)。此时想要进入容器，可以通过以下指令进入：`docker exec -it bcc /bin/bash`

![](centos-exec.png)

通过指定 -it参数来保持标准输入打开，并且分配一个伪终端。可以看到会打开一个新的 bash 终端，在不影响容器内其他应用的前提下，用户可以与容器进行交互。

### 4、删除容器

1. 删除已经停止的容器
```shell
docker rm ea5c
```
![](centos-rm.png)
2. 删除正在运行的容器
先停止，再删除。
```shell
docker rm -f bcc
```
![](centos-rm-f.png)

### 5、导入和导出容器

某些时候，需要将容器从一个系统迁移到另外一个系统，此时可以使用 Docker 的导人 和导出功能，这也是 Docker 自身提供的一个重要特性。

为了测试容器是否导出和导入成功，我们在centos容器中创建一个新的文件。

![](centos-atxt.png)

#### 1、导出容器

导出容器是指，导出一个已经创建的容器到一个文件，不管此时这个容器是否处于运行状态。
```shell
docker export -o '/home/atguigu/test\_for\_centos.tar' 9fa
```

![](centos-export.png)

可以把导出的tar文件，传输到其他设备，再通过导入命令导入，实现容器的迁移。

#### 5、导入容器

将刚导出的容器导入之后会成为镜像。

```shell
docker import test\_for\_centos.tar -- test/mycentos:1.0
```

![](centos-import.png)

使用新的镜像启动容器:

![](centos-run-atxt.png)

刚才创建的文件还在。

### 6、查看容器

#### 1、查看容器详情

```shell
docker container inspect 9fa
```
会以 json 格式返回包括容器 Id、创建时间、路径、状态、镜像、配置等在内的各项信息。
![](centos-container.png)

#### 2、查看容器内进程

```shell
docker top 9fa
```

这个子命令类似于 Linux 系统中的 top 命令，会打印出容器内的进程信息，包括 PID 、 用户、时间、命令等。

![](centos-top.png)

#### 3、查看统计信息

```shell
docker stats --no-stream 9fa
```

会显示 CPU 、内存、存储、网络等使用情况的统计信息。

![](centos-stats.png)

### 7、容器和主机之间复制文件

容器和主机之间进行文件复制的时候，要保证容器已经启动。

#### 1、从主机复制到容器

```shell
docker cp test.txt 9fa:/
```

![](centos-cpa.png)

#### 2、从容器复制到主机

```shell
docker cp 9fa:/a.txt ./
```

![](centos-cpb.png)


## 镜像高级操作

### 1、创建镜像

创建镜像的方法主要有2种：

- 基于已有容器创建。
- 基于Dockerfile文件创建。

#### 1、基于已有容器创建

```shell
docker commit -m 'add new file : a.txt' -a 'atguigu' 9fa new\_centos:1.0
```
说明:
1. -m 提交信息
2. -a 作者
3. 9fa 旧有的容器
4. new\_centos:1.0 新的镜像

![](centos-new.png)

#### 2、基于Dockerfile 创建

基于 Dockerfile 创建是最常见的方式。 Dockerfile 是一个文本文件，利用给定的指令描述**基于某个父镜像创建新镜像**的过程。

下面使用Dockerfile创建一个基于centos的java开发环境:

1. 把jdk安装转包copy到`/home/atguigu`{: .filepath}目录下
```shell
cd ~
cp jdk-8u212-linux-x64.tar.gz ./
```
2. 在`/home/atguigu`{: .filepath}上创建Dockerfile文件`vim Dockerfile`，并写入以下内容
```shell
FROM centos:7.5.1804
RUN mkdir -p /opt/software
RUN mkdir -p /opt/module
COPY jdk-8u212-linux-x64.tar.gz /opt/software/
RUN tar -zxvf /opt/software/jdk-8u212-linux-x64.tar.gz -C /opt/module
RUN rm -rf /opt/software/jdk-8u212-linux-x64.tar.gz
ENV JAVA_HOME=/opt/module/jdk1.8.0_212
ENV PATH=$JAVA_HOME/bin:$PATH
```
3. 创建镜像，并等待创建成功。
```shell
docker build -t centos\_java8:1.0 .
```
    说明:
    1. -t：指明镜像名字和标签。
    2. .：表示Dockfile所在目录。
1. 测试镜像是否可以正常工作
```shell
docker run centos\_java8:1.0 java -version
```
![](centos-java.png)

### 2、保存和加载镜像

使用保存和加载功能可以把本机的镜像发给其他人使用。

#### 1、保存镜像

```shell
docker save -o atguigu\_centos\_java8.tar centos\_java8:1.0
```

#### 2、加载镜像

把刚刚保存的镜像发给别人(hadoop103)，然后加载导入。

```shell
docker load -i atguigu\_centos\_java8.tar
```

![](centos-load.png)

## 为镜像添加ssh服务

很多镜像是不带ssh服务的，管理镜像非常的不方便，这里介绍如何给镜像添加ssh服务。

### 1、创建镜像

- Dockerfile:

```shell
# 设置继承镜像
FROM centos_java8:1.0
# 提供作者信息
MAINTAINER atguigu_lzc (lizhenchao@atguigu.com)

# 更换国内阿里云yum源
RUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
RUN sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo
RUN yum makecache

# 安装sshd
RUN yum install -y openssh-server openssh-clients
RUN sed -i '/^HostKey/'d /etc/ssh/sshd_config
RUN echo 'HostKey /etc/ssh/ssh_host_rsa_key'>>/etc/ssh/sshd_config

# 生成 ssh-key
RUN ssh-keygen -t rsa -b 2048 -f /etc/ssh/ssh_host_rsa_key

# 更改 root 用户登录密码为
RUN echo 'root:aaaaaa' | chpasswd

# 开发 22 端口
EXPOSE 22

# 镜像运行时启动sshd
RUN mkdir -p /opt
RUN echo '#!/bin/bash' >> /opt/run.sh
RUN echo '/usr/sbin/sshd -D' >> /opt/run.sh
RUN chmod +x /opt/run.sh
CMD ["/opt/run.sh"]

```

- 构建
```shell
docker build -t centos\_java8\_sshd:1.0 ./
```
### 2、运行容器，测试镜像

```shell
docker run -d -p 2222:22 centos\_java8\_sshd:1.0
```
说明: 把容器的22端口映射到宿主机器的2222端口，这样通过ssh连接宿主机器的2222端口就可以连接到容器了。
```shell
ssh root@192.168.14.112 -p 2222
```
![](centos-ssh.png)

## 端口映射与容器互联

### 1、端口映射

在启动容器的时候，如果不指定对应参数，在容器外部是无法通过网络来访问容器内的 网络应用和服务的。

使用 -p 来指定映射规则: 3000:22 表示宿主的3000映射到容器的22端口，使用多次 -p 可以映射多个端口。
```shell
docker run -d -p 2222:22 -p 8888:80 centos\_java8\_sshd:1.0
```
查看容器端口绑定情况:
```shell
docker port 9b2e0f3478ff
```
### 2、容器互相访问

端口映射并不是唯一把 docker 连接到另一个容器的方法。

docker 有一个连接系统允许将多个容器连接在一起，共享连接信息。

docker 连接会创建一个父子关系，其中父容器可以看到子容器的信息。

#### 1、容器命名

创建容器的时候，Docker会自动为容器分配一个随机的名字。我们也可以指定一个好记的名字，方便容器间的互联。
```shell
docker run -d --name hadoop102 centos\_java8\_sshd:1.0
```
说明:

- --name 参数给容器起一个名字

![](centos-name.png)

#### 2、docker的网络

docker还会给我们创建三个网络：`bridge/host/none`{: .filepath}。我们可以通过`network ls`命令查看当前宿主机中所有的docker网络。

![](centos-network.png)

其中，网桥bridge模式是在实际项目中常用的。接下来，以交互模式启动两个centos\_java8\_sshd 容器。在没有指定相关网络的情况下，容器都会连接到默认的bridge网络。

创建两个容器: hadoo102和hadoop103，检查bridge网络情况，可以看到他们的ip地址。
```shell
docker run -d --name hadoop102 centos\_java8\_sshd:1.0
docker run -d --name hadoop103 centos\_java8\_sshd:1.0
docker network inspect bridge
```
![](centos-network-bridge.png)

注意:

1. 通过ip地址我们在宿主机或者容器之间可以访问到对方
![](centos-ssh-ip.png)

1. 当是172.17.0.2 等这些ip地址不能固定，每次启动容器的时候**有可能会变化**，如果组建集群的话很不方便。

#### 3、自定义bridge网络，实现容器间通讯

docker daemon 实现了一个内嵌的 DNS server，使容器可以直接通过“容器名”通信。使用默认的bridge网络，不能通过DNS server实现通过容器名通信，但是使用自定义bridge网络可以做到通过容器名互相通信。

1. 创建自定义bridge网络，网络名atguigu
```shell
docker network create --driver bridge atguigu
```
2. 删除hadoop102和hadoop103容器
```shell
docker rm -f hadoop102
docker rm -f hadoop103
```
3. 新建并启动hadoop102和hadoop103容器，并加入到atguigu网络
```shell
docker run -d --name atguigu102 --network atguigu centos\_java8\_sshd:1.0
docker run -d --name atguigu103 --network atguigu centos\_java8\_sshd:1.0
```
![](centos-bridge-atguigu.png)

1. 进入atguigu102，测试是否可以ping通atguigu103

![](centos-bridge-atguigu2.png)
